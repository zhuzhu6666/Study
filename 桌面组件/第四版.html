<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows风格小组件</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0078D4',
                        secondary: '#0063B1',
                        accent: '#107C10',
                        neutral: '#333333',
                        'neutral-light': '#F3F2F1',
                        'neutral-dark': '#201F1E',
                        weather: {
                            sunny: '#FFC107',
                            cloudy: '#607D8B',
                            rainy: '#2196F3',
                            snowy: '#E0F7FA',
                            foggy: '#9E9E9E',
                        }
                    },
                    fontFamily: {
                        inter: ['Segoe UI', 'Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'widget': '0 4px 20px rgba(0, 0, 0, 0.1)',
                        'widget-hover': '0 8px 30px rgba(0, 0, 0, 0.15)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .widget-shadow {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            .tab-button {
                @apply px-4 py-2 transition-all duration-200 text-center;
            }
            .tab-button:not(.active) {
                @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
            }
            .tab-button.active {
                @apply bg-primary text-white font-medium;
            }
            .weather-card {
                @apply p-5 rounded-xl transition-all duration-300;
            }
            .weather-icon {
                @apply text-5xl mb-2;
            }
            .full-height-widget {
                height: 100%;
            }
            .iframe-container {
                height: calc(100% - 40px);
            }
            .responsive-iframe {
                width: 100%;
                height: 100%;
            }
            .glass-effect {
                @apply bg-white/80 backdrop-blur-md;
            }
            .hover-scale {
                @apply transition-transform duration-300 hover:scale-[1.02];
            }
        }
    </style>
    <style>
        body {
            overflow: hidden;
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
            opacity: 0.9;
            transition: opacity 0.5s ease-in-out;
        }
        .background-overlay.fade-out {
            opacity: 0;
        }
        .content-container {
            position: relative;
            z-index: 1;
        }
        /* 自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(241, 241, 241, 0.5);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(170, 170, 170, 0.5);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(136, 136, 136, 0.7);
        }
        .bg-update-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }
        .bg-update-indicator.show {
            opacity: 1;
        }
    </style>
    <script>
        let currentBackground = null;
        let backgroundUpdateInterval = null;
        
        async function updateBackgroundImage(initialLoad = false) {
            const apiKey = 'FBgyrnqz9sWVRPwlONcqLSzEFE3OD5KAvPPjSkirYW5Kz03WwMlLDTMQ';
            const query = 'nature';
            const url = `https://api.pexels.com/v1/search?query=${query}&per_page=1`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        Authorization: apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`API 请求失败: ${response.status}`);
                }

                const data = await response.json();
                if (data.photos && data.photos.length > 0) {
                    const imageUrl = data.photos[0].src.original;
                    
                    // 如果不是首次加载，先淡出当前背景
                    if (!initialLoad && currentBackground) {
                        currentBackground.classList.add('fade-out');
                        
                        // 等待淡出动画完成后再更换背景
                        setTimeout(() => {
                            replaceBackgroundImage(imageUrl);
                        }, 500);
                    } else {
                        replaceBackgroundImage(imageUrl);
                    }
                    
                    // 显示更新指示器
                    showBackgroundUpdateIndicator();
                    
                    // 保存最后更新时间
                    localStorage.setItem('lastBackgroundUpdate', new Date().toISOString());
                }
            } catch (error) {
                console.error('获取背景图片失败:', error);
                // 如果获取失败且没有当前背景，使用默认背景
                if (!currentBackground) {
                    const overlay = document.createElement('div');
                    overlay.className = 'background-overlay';
                    overlay.style.backgroundColor = '#f3f4f6';
                    document.body.insertBefore(overlay, document.body.firstChild);
                    currentBackground = overlay;
                }
            }
        }
        
        function replaceBackgroundImage(imageUrl) {
            // 创建新的背景元素
            const newBackground = document.createElement('div');
            newBackground.className = 'background-overlay';
            newBackground.style.backgroundImage = `url(${imageUrl})`;
            newBackground.style.opacity = '0';
            
            // 将新背景添加到DOM中
            document.body.insertBefore(newBackground, document.body.firstChild);
            
            // 如果有当前背景，移除它
            if (currentBackground) {
                document.body.removeChild(currentBackground);
            }
            
            // 更新当前背景引用
            currentBackground = newBackground;
            
            // 淡入新背景
            setTimeout(() => {
                currentBackground.style.opacity = '1';
            }, 100);
        }
        
        function showBackgroundUpdateIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'bg-update-indicator';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN');
            indicator.textContent = `背景已更新 · ${timeString}`;
            
            document.body.appendChild(indicator);
            
            // 显示3秒后隐藏
            setTimeout(() => {
                indicator.classList.add('show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                    
                    // 完全隐藏后移除元素
                    setTimeout(() => {
                        document.body.removeChild(indicator);
                    }, 500);
                }, 3000);
            }, 100);
        }
        
        function autoUpdateBackground() {
            // 立即更新一次背景
            updateBackgroundImage(true);
            
            // 设置每小时更新一次
            backgroundUpdateInterval = setInterval(() => {
                updateBackgroundImage(false);
            }, 60 * 60 * 1000); // 1小时
        }
        
        window.addEventListener('load', autoUpdateBackground);
        
        // 页面卸载时清除定时器
        window.addEventListener('unload', () => {
            if (backgroundUpdateInterval) {
                clearInterval(backgroundUpdateInterval);
            }
        });
    </script>
</head>
<body class="font-inter text-neutral">
    <div class="content-container flex flex-col p-4 md:p-8">
        <main class="absolute top-4 right-4 w-1/3 h-[calc(100vh-8rem)]">
            <section class="glass-effect rounded-xl shadow-widget hover:shadow-widget-hover overflow-hidden transition-all duration-300 full-height-widget">
                <div class="flex border-b border-gray-200">
                    <button id="back-button" class="tab-button" onclick="goBack()">
                        <i class="fa fa-arrow-left mr-1"></i> 返回
                    </button>
                    <button id="calendar-tab" class="tab-button active" onclick="switchTab('calendar')">日历</button>
                    <button id="news-tab" class="tab-button" onclick="switchTab('news')">新闻</button>
                    <button id="weather-tab" class="tab-button" onclick="switchTab('weather')">天气</button>
                </div>
                
                <div id="calendar-content" class="iframe-container flex-1">
                    <iframe class="responsive-iframe" frameborder="0" src="https://rili-d.jin10.com/open.php?fontSize=14px&scrolling=yes&theme=primary"></iframe>
                </div>
                
                <div id="news-content" class="iframe-container flex-1 hidden">
                    <iframe class="responsive-iframe" frameborder="0" src="https://www.jin10.com/example/jin10.com.html?fontSize=14px&theme=white"></iframe>
                </div>
                
                <div id="weather-content" class="flex-1 hidden p-5 overflow-auto h-full custom-scrollbar">
                    <div id="weather-widget" class="weather-card bg-gradient-to-br from-blue-400 to-blue-600 text-white animate-fadeIn hover-scale">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="text-xl font-bold tracking-wide">吴江天气</h3>
                            <div id="weather-update-time" class="text-sm opacity-80">加载中...</div>
                        </div>
                        
                        <div class="flex justify-between items-center mb-7">
                            <div>
                                <div id="weather-temp" class="text-[clamp(2.5rem,5vw,4rem)] font-bold loading-shimmer">--°</div>
                                <div id="weather-desc" class="text-lg mt-2 loading-shimmer">--</div>
                            </div>
                            <div id="weather-icon" class="weather-icon loading-shimmer">
                                <i class="fa fa-sun-o"></i>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="bg-white/20 p-3 rounded-lg backdrop-blur-sm">
                                <i class="fa fa-tint mr-1"></i>
                                <span id="weather-humidity" class="loading-shimmer">--%</span>
                            </div>
                            <div class="bg-white/20 p-3 rounded-lg backdrop-blur-sm">
                                <i class="fa fa-location-arrow mr-1"></i>
                                <span id="weather-wind" class="loading-shimmer">--</span>
                            </div>
                            <div class="bg-white/20 p-3 rounded-lg backdrop-blur-sm">
                                <i class="fa fa-thermometer-half mr-1"></i>
                                <span id="weather-feels" class="loading-shimmer">--°</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 animate-fadeIn" style="animation-delay: 0.2s">
                        <h3 class="text-lg font-semibold mb-3">未来预报</h3>
                        <div id="weather-forecast" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <!-- 未来天气将通过JavaScript动态填充 -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <script>
        function switchTab(tabName) {
            document.getElementById('calendar-content').classList.add('hidden');
            document.getElementById('news-content').classList.add('hidden');
            document.getElementById('weather-content').classList.add('hidden');
            
            document.getElementById('calendar-tab').classList.remove('active');
            document.getElementById('news-tab').classList.remove('active');
            document.getElementById('weather-tab').classList.remove('active');
            
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // 控制返回按钮的显示/隐藏
            const backButton = document.getElementById('back-button');
            if (tabName === 'calendar') {
                backButton.classList.remove('hidden');
            } else {
                backButton.classList.add('hidden');
            }
            
            if (tabName === 'weather') {
                resetWeatherUI();
                fetchWeatherData();
            }
        }
        
        function resetWeatherUI() {
            document.getElementById('weather-temp').classList.add('loading-shimmer');
            document.getElementById('weather-desc').classList.add('loading-shimmer');
            document.getElementById('weather-humidity').classList.add('loading-shimmer');
            document.getElementById('weather-wind').classList.add('loading-shimmer');
            document.getElementById('weather-feels').classList.add('loading-shimmer');
            document.getElementById('weather-icon').classList.add('loading-shimmer');
            document.getElementById('weather-update-time').textContent = '加载中...';
            
            document.getElementById('weather-forecast').innerHTML = '';
        }
        
        document.querySelectorAll('.calendar-day').forEach(day => {
            day.addEventListener('click', () => {
                document.querySelectorAll('.calendar-day.bg-primary').forEach(selected => {
                    selected.classList.remove('bg-primary', 'text-white', 'rounded-full');
                });
                day.classList.add('bg-primary', 'text-white', 'rounded-full');
            });
        });
        
        window.addEventListener('resize', adjustIframes);
        
        function adjustIframes() {
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    if (iframeDoc) {
                        const baseFontSize = Math.max(12, window.innerWidth / 100);
                        iframeDoc.documentElement.style.fontSize = `${baseFontSize}px`;
                    }
                } catch (e) {
                    console.log('无法访问iframe内容:', e);
                }
            });
        }
        
        window.addEventListener('load', adjustIframes);

        function goBack() {
            window.history.back();
        }
        
        function fetchWeatherData() {
            const apiKey = '4564b3b22a4c48d5a8cdf5321d7ff656';
            const locationID = '101190408'; 
            
            fetch(`https://mf564trjbf.re.qweatherapi.com/v7/weather/now?location=${locationID}&key=${apiKey}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('当前天气数据:', data);
                    updateCurrentWeather(data);
                })
                .catch(error => {
                    console.error('获取当前天气失败:', error);
                    showWeatherError('获取当前天气失败');
                });
            
            fetch(`https://mf564trjbf.re.qweatherapi.com/v7/weather/3d?location=${locationID}&key=${apiKey}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('天气预报数据:', data);
                    updateWeatherForecast(data);
                })
                .catch(error => {
                    console.error('获取天气预报失败:', error);
                    showWeatherError('获取天气预报失败');
                });
        }
        
        function showWeatherError(message) {
            document.getElementById('weather-temp').textContent = '获取失败';
            document.getElementById('weather-desc').textContent = message;
            document.getElementById('weather-update-time').textContent = '更新失败';
            
            document.getElementById('weather-temp').classList.remove('loading-shimmer');
            document.getElementById('weather-desc').classList.remove('loading-shimmer');
            document.getElementById('weather-humidity').classList.remove('loading-shimmer');
            document.getElementById('weather-wind').classList.remove('loading-shimmer');
            document.getElementById('weather-feels').classList.remove('loading-shimmer');
            document.getElementById('weather-icon').classList.remove('loading-shimmer');
        }
        
        function updateCurrentWeather(data) {
            document.getElementById('weather-temp').classList.remove('loading-shimmer');
            document.getElementById('weather-desc').classList.remove('loading-shimmer');
            document.getElementById('weather-humidity').classList.remove('loading-shimmer');
            document.getElementById('weather-wind').classList.remove('loading-shimmer');
            document.getElementById('weather-feels').classList.remove('loading-shimmer');
            document.getElementById('weather-icon').classList.remove('loading-shimmer');
            
            if (!data || !data.now) {
                showWeatherError('数据格式错误');
                return;
            }
            
            const now = data.now;
            const updateTime = new Date(data.updateTime).toLocaleTimeString('zh-CN');
            
            document.getElementById('weather-temp').textContent = `${now.temp}°`;
            document.getElementById('weather-desc').textContent = now.text;
            document.getElementById('weather-humidity').textContent = `${now.humidity}%`;
            document.getElementById('weather-wind').textContent = `${now.windDir} ${now.windScale}级`;
            document.getElementById('weather-feels').textContent = `${now.feelsLike}°`;
            document.getElementById('weather-update-time').textContent = `更新于 ${updateTime}`;
            
            setWeatherIcon(now.icon, document.getElementById('weather-icon'));
            setWeatherBackground(now.icon);
        }
        
        function updateWeatherForecast(data) {
            const forecastContainer = document.getElementById('weather-forecast');
            forecastContainer.innerHTML = '';
            
            if (!data || !data.daily || data.daily.length === 0) {
                forecastContainer.innerHTML = '<div class="col-span-full text-center text-gray-500">暂无预报数据</div>';
                return;
            }
            
            const dailyForecast = data.daily.slice(0, 3);
            
            dailyForecast.forEach(day => {
                const date = new Date(day.fxDate);
                const dayName = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][date.getDay()];
                
                const forecastItem = document.createElement('div');
                forecastItem.className = 'bg-white/80 p-3 rounded-lg shadow-sm text-center backdrop-blur-sm hover-scale';
                forecastItem.innerHTML = `
                    <div class="text-sm font-medium">${dayName}</div>
                    <div class="mt-2">
                        <i class="fa ${getWeatherIconClass(day.iconDay)} text-lg"></i>
                    </div>
                    <div class="mt-2 text-sm">${day.textDay}</div>
                    <div class="mt-1 text-xs text-gray-600">${day.tempMin}°~${day.tempMax}°</div>
                `;
                
                forecastContainer.appendChild(forecastItem);
            });
        }
        
        function setWeatherIcon(iconCode, element) {
            element.className = 'weather-icon';
            element.innerHTML = `<i class="fa ${getWeatherIconClass(iconCode)}"></i>`;
        }
        
        function getWeatherIconClass(iconCode) {
            const iconMap = {
                '100': 'fa-sun-o',
                '101': 'fa-cloud-sun-o',
                '102': 'fa-cloud',
                '103': 'fa-cloud',
                '104': 'fa-cloud',
                '200': 'fa-wind',
                '201': 'fa-wind',
                '202': 'fa-wind',
                '203': 'fa-wind',
                '204': 'fa-wind',
                '205': 'fa-wind',
                '206': 'fa-wind',
                '207': 'fa-wind',
                '208': 'fa-wind',
                '209': 'fa-wind',
                '210': 'fa-wind',
                '211': 'fa-bolt',
                '212': 'fa-bolt',
                '213': 'fa-bolt',
                '300': 'fa-tint',
                '301': 'fa-tint',
                '302': 'fa-tint',
                '303': 'fa-tint',
                '304': 'fa-tint',
                '305': 'fa-tint',
                '306': 'fa-tint',
                '307': 'fa-tint',
                '308': 'fa-tint',
                '309': 'fa-tint',
                '310': 'fa-tint',
                '311': 'fa-tint',
                '312': 'fa-tint',
                '313': 'fa-tint',
                '314': 'fa-tint',
                '315': 'fa-tint',
                '400': 'fa-snowflake-o',
                '401': 'fa-snowflake-o',
                '402': 'fa-snowflake-o',
                '403': 'fa-snowflake-o',
                '404': 'fa-snowflake-o',
                '405': 'fa-snowflake-o',
                '406': 'fa-snowflake-o',
                '407': 'fa-snowflake-o',
                '500': 'fa-cloud',
                '501': 'fa-cloud',
                '502': 'fa-cloud',
                '503': 'fa-cloud',
                '504': 'fa-cloud',
                '507': 'fa-cloud',
                '508': 'fa-cloud',
                '600': 'fa-smog',
                '601': 'fa-smog',
                '602': 'fa-smog',
                '603': 'fa-smog',
                '604': 'fa-smog',
                '900': 'fa-exclamation-triangle',
                '901': 'fa-exclamation-triangle',
                '999': 'fa-question-circle'
            };
            
            return iconMap[iconCode] || 'fa-question-circle';
        }
        
        function setWeatherBackground(iconCode) {
            const weatherWidget = document.getElementById('weather-widget');
            
            if (iconCode.startsWith('1')) {
                weatherWidget.className = 'weather-card bg-gradient-to-br from-blue-400 to-blue-600 text-white animate-fadeIn hover-scale';
            } else if (iconCode.startsWith('3')) {
                weatherWidget.className = 'weather-card bg-gradient-to-br from-blue-600 to-blue-800 text-white animate-fadeIn hover-scale';
            } else if (iconCode.startsWith('4')) {
                weatherWidget.className = 'weather-card bg-gradient-to-br from-blue-300 to-blue-500 text-white animate-fadeIn hover-scale';
            } else if (iconCode.startsWith('5') || iconCode.startsWith('6')) {
                weatherWidget.className = 'weather-card bg-gradient-to-br from-gray-400 to-gray-600 text-white animate-fadeIn hover-scale';
            } else {
                weatherWidget.className = 'weather-card bg-gradient-to-br from-blue-400 to-blue-600 text-white animate-fadeIn hover-scale';
            }
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 默认隐藏返回按钮，只有在日历标签激活时才显示
            const backButton = document.getElementById('back-button');
            backButton.classList.add('hidden');
            
            // 手动触发日历标签的点击事件
            document.getElementById('calendar-tab').click();
        });
    </script>
</body>
</html>    